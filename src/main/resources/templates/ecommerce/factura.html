<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" charset="utf-8"/>
    <title>Factura</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
    <style type="text/tailwindcss">
        :root {
            --bg-cream: #FDFCF9;
            --brown-dark: #43312A;
            --brown-medium: #6B524B;
            --brown-light: #A5928C;
            --accent-gold: #C09553;
            --gray-soft: #F3F4F6;
            --white-pure: #FFFFFF;
            --error-red: #D32F2F;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-cream);
        }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .input-field { @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-gold)] focus:border-[var(--accent-gold)] transition-colors duration-200 bg-white; }
        .btn-primary { @apply w-full bg-[var(--brown-dark)] text-white font-bold py-4 px-4 rounded-lg hover:bg-[var(--brown-medium)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-cream)] focus:ring-[var(--brown-dark)] transition-all duration-300 flex items-center justify-center shadow-lg hover:shadow-xl transform hover:-translate-y-1; }
    </style>
</head>
<body class="text-[var(--brown-dark)]">

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-10 text-center">
        <a class="text-sm text-[var(--accent-gold)] tracking-widest font-medium uppercase hover:underline" th:href="@{/ecommerce/productos}">← Volver a la tienda</a>
        <h1 class="text-4xl md:text-5xl font-playfair mt-2">Factura</h1>
        <p class="mt-3 text-lg text-[var(--brown-medium)]">Revisa tu pedido y completa el pago.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12">
        <!-- RESUMEN DEL PEDIDO -->
        <main class="lg:col-span-7">
            <div class="card p-6 sm:p-8 rounded-2xl shadow-lg bg-white">
                <h2 class="text-2xl font-playfair mb-6 border-b pb-4 border-gray-200">Resumen del Pedido</h2>
                <div class="space-y-6">
                    <div class="grid grid-cols-12 gap-4 items-center" th:each="item : ${factura.items}">
                        <div class="col-span-2">
                            <img class="w-20 h-20 rounded-lg object-cover shadow-md border border-gray-200"
                                 th:src="@{/productos/uploads/{filename}(filename=${item.imagen})}" alt="Producto"/>
                        </div>
                        <div class="col-span-5">
                            <p class="font-semibold text-base" th:text="${item.nombreProducto}"></p>
                            <p class="text-sm text-[var(--brown-medium)]">Cantidad: <span th:text="${item.cantidad}"></span></p>
                        </div>
                        <div class="col-span-2 text-right">
                            <p class="text-sm text-[var(--brown-medium)]" th:text="${#numbers.formatDecimal(item.precioUnitario, 1, 'POINT', 2, 'NONE')}"></p>
                        </div>
                        <div class="col-span-3 text-right">
                            <p class="font-semibold text-lg" th:text="${#numbers.formatDecimal(item.subtotal, 1, 'POINT', 2, 'NONE')}"></p>
                        </div>
                    </div>
                </div>

                <hr class="my-8 border-t border-gray-200 border-dashed"/>
                <div class="space-y-3 text-[var(--brown-medium)]">
                    <div class="flex justify-between text-base">
                        <span>Subtotal</span>
                        <span class="font-medium text-[var(--brown-dark)]" th:text="${factura.subtotal}"></span>
                    </div>
                    <div class="flex justify-between text-base">
                        <span>Envío</span>
                        <span class="font-medium text-[var(--brown-dark)]" th:text="${factura.envio}"></span>
                    </div>
                    <div class="flex justify-between text-base">
                        <span>Impuestos</span>
                        <span class="font-medium text-[var(--brown-dark)]" th:text="${factura.impuestos}"></span>
                    </div>
                </div>
                <hr class="my-6 border-t border-gray-300"/>
                <div class="flex justify-between items-center mt-6">
                    <span class="text-xl font-playfair font-bold">Total</span>
                    <span class="text-3xl font-bold" th:text="${factura.total}"></span>
                </div>
            </div>
        </main>

        <!-- FORMULARIO DE PAGO -->
        <aside class="lg:col-span-5">
            <div class="card p-6 sm:p-8 rounded-2xl shadow-lg bg-white">
                <h2 class="text-2xl font-playfair mb-6 border-b pb-4 border-gray-200">Detalles de Pago</h2>

                <form class="space-y-8" th:action="@{/ecommerce/pagar}" method="post" th:object="${datosPago}">
                    <h2 class="text-2xl font-playfair mb-4">Dirección de Entrega</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nombre:</label>
                            <input class="input-field" type="text" th:field="*{nombre}" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Apellido:</label>
                            <input class="input-field" type="text" th:field="*{apellido}" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Dirección:</label>
                        <input class="input-field" type="text" th:field="*{direccion}" />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Ciudad:</label>
                            <input class="input-field" type="text" th:field="*{ciudad}" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Código Postal:</label>
                            <input class="input-field" type="text" th:field="*{codigoPostal}" />
                        </div>
                    </div>

                    <h2 class="text-2xl font-playfair mb-4">Método de Pago</h2>
                    <div>
                        <label>
                            <input type="radio" th:field="*{metodoPago}" value="Tarjeta" id="radioTarjeta" checked /> Tarjeta de Crédito
                        </label>
                        <label>
                            <input type="radio" th:field="*{metodoPago}" value="Efectivo" id="radioEfectivo" /> Efectivo
                        </label>
                    </div>
                    <div id="tarjetaFields">
                        <div>
                            <label class="block text-sm font-medium mb-2">Número de Tarjeta:</label>
                            <input class="input-field" type="text" th:field="*{numeroTarjeta}" maxlength="16"/>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Fecha de Expiración:</label>
                                <input class="input-field" type="text" th:field="*{fechaExpiracion}" placeholder="MM/AA"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">CVV:</label>
                                <input class="input-field" type="text" th:field="*{cvv}" maxlength="3"/>
                            </div>
                        </div>
                    </div>
                    <div id="efectivoMsg" style="display:none;">
                        <p class="text-sm text-green-700 font-semibold mt-2">El pago se realizará en efectivo al momento de la entrega.</p>
                    </div>
                    <button class="btn-primary" type="submit">
                        <span class="material-symbols-outlined mr-2">lock</span>
                        Pagar <span th:text="${factura.total}"></span>
                    </button>
                    <p class="text-xs text-center text-[var(--brown-medium)] mt-4" th:if="${error}" th:text="${error}" style="color: red;"></p>
                </form>
            </div>
        </aside>
    </div>
</div>
<script>
    window.addEventListener('DOMContentLoaded', () => {
    radioTarjeta.checked = true;
    togglePagoFields();
    });

    const radioTarjeta = document.getElementById('radioTarjeta');
    const radioEfectivo = document.getElementById('radioEfectivo');
    const tarjetaFields = document.getElementById('tarjetaFields');
    const efectivoMsg = document.getElementById('efectivoMsg');

    function togglePagoFields() {
        if (radioTarjeta.checked) {
            tarjetaFields.style.display = 'block';
            efectivoMsg.style.display = 'none';
        } else {
            tarjetaFields.style.display = 'none';
            efectivoMsg.style.display = 'block';
        }
    }
    radioTarjeta.addEventListener('change', togglePagoFields);
    radioEfectivo.addEventListener('change', togglePagoFields);
    window.addEventListener('DOMContentLoaded', togglePagoFields);
</script>
</body>
</html>
